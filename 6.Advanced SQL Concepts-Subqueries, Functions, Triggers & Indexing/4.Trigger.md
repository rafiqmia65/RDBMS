# ðŸ“˜ PostgreSQL Triggers Explained (PL/pgSQL)

## ðŸ”¹ What is a Trigger?

A **Trigger** is a database object in PostgreSQL that **automatically executes** a function whenever a specific event occurs on a table.

> In simple terms: triggers act like automatic rules for your database. You donâ€™t call them manuallyâ€”they fire when something happens.

---

## ðŸ”¹ Why Use Triggers?

- **Enforce rules automatically**: e.g., salary should never be negative.
- **Maintain audit logs**: track insert, update, delete.
- **Ensure data consistency**.
- **Reduce application-side logic**: database handles certain tasks itself.

---

## ðŸ”¹ Trigger Events

| Event    | Description                          |
| -------- | ------------------------------------ |
| `INSERT` | Fires when new data is inserted      |
| `UPDATE` | Fires when existing data is modified |
| `DELETE` | Fires when data is removed           |

---

## ðŸ”¹ Trigger Timing

| Timing   | Description                                          |
| -------- | ---------------------------------------------------- |
| `BEFORE` | Runs **before** the action executes (can prevent it) |
| `AFTER`  | Runs **after** the action executes                   |

---

# ðŸ”¹ Example Tables (Common for All Examples)

```sql
CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    salary NUMERIC
);

CREATE TABLE employee_audit (
    audit_id SERIAL PRIMARY KEY,
    emp_id INT,
    action VARCHAR(50),
    action_time TIMESTAMP
);
```

> These tables will be used to demonstrate auditing and validation triggers.

---

# ðŸ”¹ Example 1: AFTER INSERT Trigger (Audit Log)

### ðŸŽ¯ Scenario

Whenever a new employee is added, we want to **automatically log this action** in `employee_audit`.

### Step 1: Create Trigger Function

```sql
CREATE OR REPLACE FUNCTION log_employee_insert()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO employee_audit(emp_id, action, action_time)
    VALUES (NEW.id, 'INSERT', NOW());

    RETURN NEW;
END;
$$;
```

### Step 2: Create Trigger

```sql
CREATE TRIGGER after_employee_insert
AFTER INSERT ON employees
FOR EACH ROW
EXECUTE FUNCTION log_employee_insert();
```

âœ… Key Points:

- `FOR EACH ROW` â†’ trigger fires for every inserted row.
- `NEW` â†’ refers to the new row being inserted.
- `AFTER INSERT` â†’ ensures the insert is done before logging.

---

# ðŸ”¹ Example 2: BEFORE UPDATE Trigger (Salary Validation)

### ðŸŽ¯ Scenario

Prevent updates that would set **negative salary**.

```sql
CREATE OR REPLACE FUNCTION check_salary_before_update()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    IF NEW.salary < 0 THEN
        RAISE EXCEPTION 'Salary cannot be negative';
    END IF;

    RETURN NEW;
END;
$$;
```

```sql
CREATE TRIGGER before_salary_update
BEFORE UPDATE ON employees
FOR EACH ROW
EXECUTE FUNCTION check_salary_before_update();
```

âœ… Key Points:

- `BEFORE UPDATE` â†’ can **block the operation** if condition fails.
- `RAISE EXCEPTION` â†’ PostgreSQL way of throwing errors.
- `NEW.salary` â†’ updated value.

---

# ðŸ”¹ Example 3: AFTER DELETE Trigger (Audit Log)

### ðŸŽ¯ Scenario

Whenever an employee is deleted, log it for auditing.

```sql
CREATE OR REPLACE FUNCTION log_employee_delete()
RETURNS TRIGGER
LANGUAGE plpgsql
AS $$
BEGIN
    INSERT INTO employee_audit(emp_id, action, action_time)
    VALUES (OLD.id, 'DELETE', NOW());

    RETURN OLD;
END;
$$;
```

```sql
CREATE TRIGGER after_employee_delete
AFTER DELETE ON employees
FOR EACH ROW
EXECUTE FUNCTION log_employee_delete();
```

âœ… Key Points:

- `OLD` â†’ refers to the row that is being deleted.
- `AFTER DELETE` â†’ ensures deletion happens before logging.

---

# ðŸ”¹ Dropping Triggers

```sql
DROP TRIGGER after_employee_insert ON employees;
DROP FUNCTION log_employee_insert;

DROP TRIGGER before_salary_update ON employees;
DROP FUNCTION check_salary_before_update;

DROP TRIGGER after_employee_delete ON employees;
DROP FUNCTION log_employee_delete;
```

---

## ðŸ”¹ PostgreSQL Trigger Concepts Recap

| Feature          | Notes                                        |
| ---------------- | -------------------------------------------- |
| Trigger function | **Required** in PostgreSQL                   |
| Language         | PL/pgSQL                                     |
| Execution        | Automatic on events (INSERT, UPDATE, DELETE) |
| Timing           | BEFORE / AFTER                               |
| Error handling   | Advanced (`RAISE EXCEPTION`)                 |
| Scope            | Row-level or Statement-level                 |

---

## ðŸ”¹ Best Practices

- Keep trigger logic **small and focused**.
- Avoid heavy **business logic** in triggers.
- Use mainly for **auditing, validation, consistency**.
- **Document trigger behavior** clearly.

---

## ðŸ”¹ Trigger vs Function vs Procedure

| Feature        | Trigger  | Procedure | Function |
| -------------- | -------- | --------- | -------- |
| Auto execution | âœ… Yes   | âŒ No     | âŒ No    |
| Return value   | âŒ       | âŒ        | âœ…       |
| Called by      | DB Event | CALL      | SELECT   |

---

## ðŸ”¹ Summary

- PostgreSQL triggers are **powerful** for data integrity.
- They **automate repetitive tasks**.
- Use **BEFORE** to validate/prevent actions.
- Use **AFTER** to maintain logs or audit trails.
- Learning triggers is essential for **interviews & production-ready DB design**.

---

**Author:** Md Rafiq Mia
**Use Case:** PostgreSQL Trigger Documentation (GitHub-ready)
